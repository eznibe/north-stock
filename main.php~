<?php

include_once 'include/php-dump.php';

//check_session();

function desconectar ()
{
 session_unset();
 session_destroy();
 $var="";
 eval_html('index.php',$var);
// eval_html('window_close.html',$var);
// eval_html('main_menu_desconectado.html',$var);
}

function check_session() {
  session_start();
  if (!isset($_SESSION["valid_user"])) 
  {
   desconectar();
   exit();
  }
}    



function eval_html($filename, $var) { 
  if ((file_exists($filename)) and (is_readable($filename))) {
    $handle = fopen($filename, "r"); 
    $openedfile = fread($handle, filesize($filename)); 

    eval('?>' . $openedfile);
  }
  else {
    print "<br />The file $filename does not exist or is not readable<br />";
  }
}

function get_units_opt($id_unidad)
{
 $unidades = "";
 $query = "SELECT Unidad.id_unidad, Unidad.unidad
           FROM Unidad";
 $result = mysql_query($query);
 while ($row = mysql_fetch_array($result))
 {
  if ($row[0] == $id_unidad) $option = "option selected";
  else $option = "option";
  $unidades = $unidades . "<$option value=\"" . htmlspecialchars(stripslashes($row[0])) . "\">" . htmlspecialchars(stripslashes($row[1])) . "</option>\n";
 }
 return $unidades;
}

function get_group_opt($id_grupo)
{
 $query = "SELECT id_grupo, grupo FROM Grupo ORDER BY grupo";
 $result = mysql_query($query);
 if (mysql_num_rows($result) > 0)
 {
  while ($row = mysql_fetch_array($result))
  {
   if ($row[0] == $id_grupo) $option = "option selected";
   else $option = "option";
   $grupo = $grupo . "<$option value=\"" . htmlspecialchars(stripslashes($row[0])) . "\">" . htmlspecialchars(stripslashes($row[1])) . "</option>\n";
  }
 }
 return $grupo;
}

function get_pais_opt($id_pais)
{
 $query = "SELECT id_pais, pais FROM Pais ORDER BY pais";
 $result = mysql_query($query);
 if (mysql_num_rows($result) > 0)
 {
  while ($row = mysql_fetch_array($result))
  {
   if ($row[0] == $id_pais) $option = "option selected";
   else $option = "option";
   $pais = $pais . "<$option value=\"" . htmlspecialchars(stripslashes($row[0])) . "\">" . htmlspecialchars(stripslashes($row[1])) . "</option>\n";
  }
 }
 return $pais;
}

function get_categoria_opt($id_categoria)
{
 $query = "SELECT id_categoria, categoria FROM Categoria ORDER BY categoria";
 $result = mysql_query($query);
 if (mysql_num_rows($result) > 0)
 {
  while ($row = mysql_fetch_array($result))
  {
   if ($row[0] == $id_categoria) $option = "option selected";
   else $option = "option";
   $categoria = $categoria . "<$option value=\"" . htmlspecialchars(stripslashes($row[0])) . "\">" . htmlspecialchars(stripslashes($row[1])) . "</option>\n";
  }
 }
 return $categoria;
}

function get_subproducto_opt($id_item)
{
 $query = "SELECT 
	Item.id_item, concat(Categoria.categoria, \" - \", Proveedor.proveedor)
	FROM
	Item, Categoria, Proveedor
	WHERE (
	(Item.id_categoria = Categoria.id_categoria) AND
	(Item.id_proveedor = Proveedor.id_proveedor)
	)
	ORDER BY Categoria.categoria";
 $result = mysql_query($query);
 if (mysql_num_rows($result) > 0)
 {
  while ($row = mysql_fetch_array($result))
  {
   if ($row[0] == $id_item) $option = "option selected";
   else $option = "option";
   $subproducto = $subproducto . "<$option value=\"" . htmlspecialchars(stripslashes($row[0])) . "\">" . htmlspecialchars(stripslashes($row[1])) . "</option>\n";
  }
 }
 return $subproducto;
}

function get_scan_opt($scan)
{
 $scanvals = array('si', 'no');
 foreach ($scanvals as $val)
 {
  if ($val == $scan) $option = "option selected";
  else $option = "option";
  $scan_opt = $scan_opt . "<$option value=\"" . $val . "\">" . $val . "</option>\n";
 }
 return $scan_opt;
}

function get_proveedor_opt($id_proveedor)
{
 $query = "SELECT 
	Proveedor.id_proveedor, Proveedor.proveedor
  FROM
	Proveedor
  ORDER BY Proveedor.proveedor";
 $result = mysql_query($query);
 if (mysql_num_rows($result) > 0)
 {
  while ($row = mysql_fetch_array($result))
  {
   if ($row[0] == $id_proveedor) $option = "option selected";
   else $option = "option";
   $proveedor = $proveedor . "<$option value=\"" . htmlspecialchars(stripslashes($row[0])) . "\">" . htmlspecialchars(stripslashes($row[1])) . "</option>\n";
  }
 }
 return $proveedor;
}

function get_tipousr_opt($id_tipo)
{
 $query = "SELECT id_tipousr, tipousr FROM Tipousr ORDER BY tipousr";
 $result = mysql_query($query);
 if (mysql_num_rows($result) > 0)
 {
  while ($row = mysql_fetch_array($result))
  {
   if ($row[0] == $id_tipo) $option = "option selected";
   else $option = "option";
   $tipousr = $tipousr . "<$option value=\"" . htmlspecialchars(stripslashes($row[0])) . "\">" . htmlspecialchars(stripslashes($row[1])) . "</option>\n";
  }
 }
 return $tipousr;
}

function get_usuario_opt($id_usuario)
{
 $query = "SELECT id_usuario, username FROM Usuario ORDER BY username";
 $result = mysql_query($query);
 if (mysql_num_rows($result) > 0)
 {
  while ($row = mysql_fetch_array($result))
  {
   if ($row[0] == $id_usuario) $option = "option selected";
   else $option = "option";
   $usuario = $usuario . "<$option value=\"" . htmlspecialchars(stripslashes($row[0])) . "\">" . htmlspecialchars(stripslashes($row[1])) . "</option>\n";
  }
 }
 return $usuario;
}

function log_trans($username, $id_accion, $id_item, $cantidad, $fecha, $id_orden='NULL')
{
 // id_accion: 1 ingreso 2 egreso 3 update 4 confirma orden 5 elimina orden 6 orden arribada completa 8 elimina item de orden
 $query = "INSERT INTO Log
	(username, id_accion, id_item, cantidad, fecha, id_orden)
  VALUES
	(\"$username\", $id_accion, $id_item, $cantidad, \"$fecha\", $id_orden)";
 $result = mysql_query($query);
 echo mysql_error();
}

function get_group($id_grupo)
{
 $query = "SELECT grupo FROM Grupo WHERE id_grupo = $id_grupo";
 $result = mysql_query($query);
 mysql_num_rows($result);
 $row = mysql_fetch_array($result);
 return $row[0];
}

function get_groups()
{
 $query = "SELECT * FROM Grupo ORDER BY grupo";
 $result = mysql_query($query);
 return $result;
}

function get_proveedor($id_proveedor)
{
 $query = "SELECT proveedor FROM Proveedor WHERE id_proveedor = $id_proveedor";
 $result = mysql_query($query);
 mysql_num_rows($result);
 $row = mysql_fetch_array($result);
 return $row[0];
}

function get_categoria($id_categoria)
{
 $query = "SELECT categoria FROM Categoria WHERE id_categoria = $id_categoria";
 $result = mysql_query($query);
 mysql_num_rows($result);
 $row = mysql_fetch_array($result);
 return $row[0];
}

function get_usuario($id_usuario, $tipo)
{
 //$tipo: 1: retorna username
 //	      2: retorna nombre de usuario
 if($tipo==1) $query = "SELECT username FROM Usuario WHERE id_usuario = $id_usuario";
 else         $query = "SELECT nombre   FROM Usuario WHERE id_usuario = $id_usuario";  
 $result = mysql_query($query);
 mysql_num_rows($result);
 $row = mysql_fetch_array($result);
 return $row[0];
}

function get_item($id_item)
{
 $query = "SELECT 
	CONCAT(Categoria.categoria, \" - \", Proveedor.proveedor) 
  FROM 
	Item, 
	Categoria, 
	Proveedor 
  WHERE (
	(Item.id_item = $id_item) AND
	(Categoria.id_categoria = Item.id_categoria) AND
	(Proveedor.id_proveedor = Item.id_proveedor)
	)";
 $result = mysql_query($query);
 mysql_num_rows($result);
 $row = mysql_fetch_array($result);
 return $row[0];
}

function get_unidad_descarga($id_categoria)
{
 $query = "SELECT Unidad.unidad
        FROM Unidad, Categoria
        WHERE
                Unidad.id_unidad = Categoria.id_unidad_visual AND
                Categoria.id_categoria = $id_categoria";
 $result = mysql_query($query);
 $row = mysql_fetch_array($result);
 return (strtoupper($row[0]));
}

/**
 * Obtiene la unidad de compra del item dado
 */
function get_unidad_compra($id_item)
{
 $query = "SELECT Unidad.unidad
  		   FROM Unidad, Item
    	   WHERE
            	Unidad.id_unidad = Item.id_unidad_compra AND
            	Item.id_item = $id_item";
 $result = mysql_query($query);
 $row = mysql_fetch_array($result);
 return (strtoupper($row[0]));
}

function get_stock_transito($id_item)
{
 $query = "SELECT Item.stock_transito
        FROM Item
        WHERE Item.id_item = $id_item";
 $result = mysql_query($query);
 $row = mysql_fetch_array($result);
 return $row[0];
}

function set_stock_transito($id_item, $stock)
{
 $query = "UPDATE Item
        SET
		stock_transito = $stock
        WHERE
                Item.id_item = $id_item";
 return mysql_query($query);
}

function log_stock_transito_negativo($username, $id_item,  $id_orden, $stock_transito_actual, $stock_transito_nuevo, $cantidad_pendiente, $cantidad_user, $tipo_accion) {
{
 $query = "INSERT INTO DG_transito_negativo
		   (username, id_item, id_orden, stock_transito_actual, stock_transito_nuevo, cantidad_pendiente, cantidad_user, tipo_accion)
  		   VALUES
		   (\"$username\", $id_item, $id_orden, $stock_transito_actual, $stock_transito_nuevo, $cantidad_pendiente, $cantidad_user, \"$tipo_accion\")";
 //var_dump($query);
 $result = mysql_query($query);
 echo mysql_error();
}
}

/**
 * Obtine el factor de unidades del item pasado como parametro
 */
function get_factor_unidades($id_item)
{
 $query = "SELECT Item.factor_unidades
        FROM Item
        WHERE Item.id_item = $id_item";
 $result = mysql_query($query);
 $row = mysql_fetch_array($result);
 return $row[0];
}

function get_cantidad_comprar($id_orden_item)
{
 $query = "SELECT OrdenItem.cantidad
        FROM OrdenItem
        WHERE OrdenItem.id_orden_item = $id_orden_item";
 $result = mysql_query($query);
 $row = mysql_fetch_array($result);
 return $row[0];
}

function get_ordenitem_id_item($id_orden_item)
{
 $query = "SELECT OrdenItem.id_item
        FROM OrdenItem
        WHERE
                OrdenItem.id_orden_item = $id_orden_item";
 $result = mysql_query($query);
 $row = mysql_fetch_array($result);
 return $row[0];
}

function get_orden_status($id_orden)
{
 $query = "SELECT Orden.id_status
        FROM Orden
        WHERE Orden.id_orden = $id_orden";
 $result = mysql_query($query);
 $row = mysql_fetch_array($result);
 return $row[0];
}

function get_ordenes_a_confirmar($id_proveedor)
{
 $condition = "";
 if(isset($id_proveedor) && !empty($id_proveedor)) {
	$condition =  " AND Proveedor.id_proveedor = $id_proveedor ";
 }

 $query = "SELECT Orden.id_orden, DATE_FORMAT(Orden.fecha, '%d-%m-%Y') AS fecha, proveedor
           FROM 
		Orden, 
		OrdenItem, 
		Item, 
		Proveedor 
	  WHERE ( 
		(Orden.id_status = 0) AND 
		(OrdenItem.id_orden = Orden.id_orden) AND 
		(Item.id_item = OrdenItem.id_item) AND 
		(Proveedor.id_proveedor = Item.id_proveedor)
		$condition
	  )
	  GROUP BY Orden.id_orden, Orden.fecha, proveedor	 
	  ORDER BY fecha, proveedor";
 $result = mysql_query($query);
 return $result;
}

function get_agrupacion_contable($id_categoria)
{
 $query = "SELECT g.agrupacion_contable FROM Grupo g join Categoria c on c.id_grupo = g.id_grupo
		   WHERE c.id_categoria = $id_categoria";
 $result = mysql_query($query);
 $row = mysql_fetch_array($result);
 return $row[0];	
}

function get_item_agrupacion_contable($id_item)
{
 $query = "SELECT i.agrupacion_contable FROM Item i
		   WHERE i.id_item = $id_item";
 $result = mysql_query($query);
 $row = mysql_fetch_array($result);
 return $row[0];	
}

function get_tipos_de_envio() {

 $query = "SELECT * FROM TipoEnvio ORDER BY id_tipo_envio";
 $result = mysql_query($query);

 return $result;
}

function es_proveedor_nacional($id_proveedor, $pais) {
	$query = "SELECT pais FROM pais, proveedor
		  WHERE pais.id_pais = proveedor.id_pais AND proveedor.id_proveedor = $id_proveedor";
	$result = mysql_query($query);
	$row = mysql_fetch_array($result);

	return $row[0] == $pais;
}

// Los parametros indican la fecha a seleccionar por default
function armar_select_fechas($dia_ini, $mes_ini, $ano_ini)
{
  
	$meses = array('enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre');

  	$codigo = "<select name='dia_ini' id='dia_ini' class='obligatorio'>";
				for ($i = 1; $i <= 31; $i++) {
					$dia = sprintf("%02d", $i);
				    $codigo = $codigo . ((!empty($dia_ini) && $dia_ini==$dia) ? "<option value='".$dia."' selected>" : "<option value='".$dia."'>"). $i ."</option>";
				}
	$codigo = 	$codigo .
				"</select>
				/
				<select name='mes_ini' id='mes_ini' class='obligatorio'>";
				$count=1;
				foreach ($meses as $mesDesc) {
					$mes = sprintf("%02d", $count);
				    $codigo = $codigo . ((!empty($mes_ini) && $mes_ini==$mes) ? "<option value='".$mes."' selected>" : "<option value='".$mes."'>"). $mesDesc ."</option>";
				    $count++;
				}
	$codigo = 	$codigo .
				"</select>
				/
				<select name='ano_ini' id='ano_ini' class='obligatorio'>";
				for ($i = 2004; $i <= 2015; $i++) {
				    $codigo = $codigo . ((!empty($ano_ini) && $ano_ini==$i) ? "<option value='".$i."' selected>" : "<option value='".$i."'>"). $i ."</option>";
				}
	$codigo = 	$codigo . "</select>";

	return $codigo;
}

?>
